<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Event Overlay</title>
    <style>
        body {
            background-color: transparent; /* Transparent background */
            color: #eee;
            font-family: monospace;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Hide the top bar */
        #top-bar {
            display: none;
        }

        #stage {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .center-box {
            width: 300px;
            height: 300px;
            border: 2px solid rgba(124,252,0,0.25);
            position: relative;
            background-color: rgba(0, 0, 0, 0.35);
            border-radius: 50%; /* Make the box circular to match the radar feel */
            /* Allow dragging the window by clicking the box */
            -webkit-app-region: drag;
            /* Ensure interactive elements inside are clickable if needed */
        }

        #degree-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border-radius: 50%;
            border: 2px solid rgba(124,252,0,0.1);
            z-index: 0;
            transition: background 0.1s;
            /* Prevent dragging from the ring itself if it interferes, but usually fine */
        }

    </style>
</head>
<body>

    <div id="top-bar">Waiting for data...</div>

    <div id="stage">
        <div class="center-box">
            <div id="degree-ring"></div>
        </div>
    </div>

    <script>
        const topBar = document.getElementById('top-bar');
        const degreeRing = document.getElementById('degree-ring');

        // Event types to ignore (won't display on overlay)
        const IGNORED_EVENTS = [
            'silence',
            'general noise',
            'vehicle'
        ];

        // Unique colors per event type (non-silence)
        const EVENT_COLORS = {
            gun:          'rgba(255, 80, 80, 1.0)',    // Bright Red
            footsteps:    'rgba(255, 255, 0, 1.0)',    // Bright Yellow
            vehicle:      'rgba(64, 156, 255, 1.0)',   // Bright Blue
            voices:       'rgba(50, 255, 80, 1.0)',    // Bright Green
            'general noise': 'rgba(220, 100, 255, 1.0)', // Bright Purple
            other:        'rgba(255, 165, 0, 1.0)'     // Bright Orange
        };

        // SVG Icons (from data/svg folder)
        const ICONS = {
            gun: `<svg fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><g><g><path d="M363.929,0l-12.346,12.346L340.036,0.799l-21.458,21.458l11.547,11.547L107.782,256.147L96.235,244.6l-21.458,21.458 l11.863,11.863c-17.171,21.661-18.478,51.842-3.925,74.805L399.683,35.755L363.929,0z"/></g></g><g><g><path d="M304.934,330.282c27.516-27.516,29.126-71.268,4.845-100.695l129.522-129.523l-30.506-30.506L115.402,362.954 l30.506,30.506l16.191-16.191L259.625,512l84.679-84.679l-57.279-79.13L304.934,330.282z M269.003,323.296l-18.666-25.788 l-3.561-4.919l5.696-5.696l15.814,15.814l21.458-21.458l-15.814-15.814l14.228-14.228c12.546,17.432,10.985,41.949-4.683,57.617 L269.003,323.296z"/></g></g></svg>`,
            footsteps: `<svg fill="currentColor" viewBox="0 0 515.458 515.458" xmlns="http://www.w3.org/2000/svg"><g><path d="M298.794,386.711c27.805,9.522,52.357,15.587,87.633,26.427C372.875,584.374,210.952,516.371,298.794,386.711z M443.366,229.409c-1.826-51.415-10.882-118.86-83.017-108.292c-33.815,8.825-58.8,45.962-70.551,110.035 c-6.454,35.229-2.701,84.678,4.912,114.32c6.951,20.889,4.587,19.605,12.058,23.572c28.916,6.514,57.542,13.725,86.693,21.078 C423.075,369.209,447.397,258.182,443.366,229.409z M220.752,225.463c7.607-29.646,11.36-79.095,4.909-114.32 C213.919,47.067,188.931,9.924,155.11,1.105C82.975-9.463,73.919,57.981,72.093,109.399 c-4.031,28.768,20.294,139.802,49.911,160.711c29.149-7.353,57.771-14.558,86.696-21.078 C216.162,245.069,213.798,246.352,220.752,225.463z M129.029,293.132c13.547,171.234,175.47,103.231,87.63-26.427 C188.854,276.228,164.304,282.292,129.029,293.132z"/></g></svg>`,
            vehicle: `<svg fill="currentColor" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 1L1.66667 5H0V8H1V15H3V13H13V15H15V8H16V5H14.3333L13 1H3ZM4 9C3.44772 9 3 9.44772 3 10C3 10.5523 3.44772 11 4 11C4.55228 11 5 10.5523 5 10C5 9.44772 4.55228 9 4 9ZM11.5585 3H4.44152L3.10819 7H12.8918L11.5585 3ZM12 9C11.4477 9 11 9.44772 11 10C11 10.5523 11.4477 11 12 11C12.5523 11 13 10.5523 13 10C13 9.44772 12.5523 9 12 9Z"/></svg>`,
            voices: `<svg fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><g><path d="M493.332,386.691c11.748-16.658,18.686-36.368,18.668-57.342c0.018-26.135-10.753-50.179-28.138-69.036 c-17.411-18.91-41.393-33.001-68.928-40.504L407.7,246.41c22.994,6.247,42.461,17.95,55.861,32.562 c13.436,14.665,20.849,31.862,20.867,50.377c-0.018,14.898-4.811,28.882-13.652,41.483c-8.831,12.565-21.792,23.613-37.722,31.772 l-11.64,5.96l15.087,33.737c-45.719-7.962-88.134-22.806-109.585-31.162l-0.422-0.161l-0.431-0.135 c-28.765-9.02-51.202-26.754-62.627-47.702l-24.179,13.265c15.473,28.11,43.547,49.453,77.68,60.429v0.009 c26.53,10.277,82.274,29.824,140.836,36.376l23.945,2.657l-24.753-55.358C471.487,411.362,483.962,400.009,493.332,386.691z"/><path d="M359.056,286.789c22.366-25.526,35.918-57.261,35.9-91.564c0.009-22.429-5.78-43.852-16.065-63.068 c-15.446-28.855-40.819-52.809-72.214-69.593c-31.403-16.774-68.937-26.432-109.199-26.441 c-53.67,0.018-102.513,17.143-138.44,45.53c-17.959,14.207-32.687,31.27-42.973,50.503C5.78,151.374-0.009,172.797,0,195.226 c-0.018,28.621,9.433,55.52,25.57,78.415c13.795,19.61,32.472,36.367,54.488,49.48l-33.163,74.16l23.946-2.656 c82.688-9.245,161.874-36.968,199.461-51.526C306.04,331.691,336.86,312.152,359.056,286.789z M260.743,317.233l-0.422,0.161 c-32.534,12.656-98.366,35.641-168.309,46.536l23.703-53.007l-11.641-5.959c-23.487-12.026-42.73-28.379-55.959-47.191 c-13.239-18.838-20.526-40.001-20.544-62.546c0.009-17.699,4.497-34.509,12.808-50.072c12.439-23.298,33.647-43.717,60.887-58.266 c27.23-14.558,60.375-23.2,96.212-23.192c47.783-0.018,90.782,15.384,121.342,39.58c15.285,12.098,27.455,26.342,35.757,41.877 c8.302,15.563,12.798,32.374,12.807,50.072c-0.017,26.979-10.473,52.082-29.079,73.415c-18.587,21.28-45.396,38.477-77.131,48.457 L260.743,317.233z"/></g></svg>`,
            'general noise': `<svg fill="currentColor" viewBox="0 0 76.01 76.01" xmlns="http://www.w3.org/2000/svg"><path d="M 20.5862,33.2547L 26.9204,33.2546L 36.4217,25.3369L 36.4217,52.2573L 26.9204,42.756L 20.5862,42.756C 18.8371,42.756 17.4191,41.338 17.4191,39.5889L 17.4191,36.4218C 17.4191,34.6726 18.8371,33.2547 20.5862,33.2547 Z M 50.6737,38.0053C 50.6737,41.4696 49.0845,44.5627 46.5954,46.5954L 44.3398,44.3399C 46.2628,42.8953 47.5066,40.5956 47.5066,38.0053C 47.5066,35.4151 46.2628,33.1153 44.3398,31.6708L 46.5954,29.4152C 49.0845,31.4479 50.6737,34.541 50.6737,38.0053 Z M 44.3395,38.0053C 44.3395,40.1167 42.9621,41.9064 41.0568,42.5248L 39.5889,39.5889C 40.4634,39.5889 41.1724,38.8799 41.1724,38.0053C 41.1724,37.1307 40.4634,36.4218 39.5889,36.4218L 41.0568,33.4858C 42.9621,34.1042 44.3395,35.8939 44.3395,38.0053 Z "/></svg>`,
            other: `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>`
        };
        
        // Fallback icon
        const DEFAULT_ICON = `<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>`;

        const ws = new WebSocket('ws://127.0.0.1:8080');

        ws.onopen = () => {
            console.log("Connected to WebSocket.");
        };

        ws.onmessage = (event) => {
            const rawData = event.data;

            // 3. Reset ring (clear previous icons and gradients)
            degreeRing.style.background = 'none';
            degreeRing.style.backgroundImage = 'none';
            degreeRing.innerHTML = ''; // Clear icons

            try {
                const data = JSON.parse(rawData);

                let items = [];
                if (Array.isArray(data)) {
                    items = data.flat(Infinity);
                } else if (typeof data === 'object' && data !== null) {
                    items = [data];
                }

                const ringGradients = [];

                items.forEach(item => {
                    if (!item || typeof item !== 'object') return;

                    const eventName = (item.event || '').toLowerCase();
                    
                    // ---------- Degree ring ----------
                    if (
                        item.degree !== undefined &&
                        item.degree !== null &&
                        eventName &&
                        !IGNORED_EVENTS.includes(eventName)
                    ) {
                        const deg = parseFloat(item.degree);
                        if (!isNaN(deg)) {
                            const color = EVENT_COLORS[eventName] || 'rgba(124,252,0,0.8)';

                            // 1. Add Gradient Wedge
                            const startAngle = deg - 20;
                            const gradient = `
                                conic-gradient(
                                    from ${startAngle}deg,
                                    transparent 0deg,
                                    ${color} 10deg,
                                    ${color} 30deg,
                                    transparent 40deg
                                )
                            `.replace(/\s+/g, ' '); 
                            ringGradients.push(gradient);

                            // 2. Add Icon
                            const iconContainer = document.createElement('div');
                            iconContainer.style.position = 'absolute';
                            iconContainer.style.width = '28px';
                            iconContainer.style.height = '28px';
                            iconContainer.style.color = color; // Icon inherits this color
                            // Add drop shadow to make it pop against any background
                            iconContainer.style.filter = 'drop-shadow(0 0 2px rgba(0,0,0,1)) drop-shadow(0 0 5px rgba(0,0,0,0.5))';
                            

                            const radius = 95; // slightly inside
                            const rad = (deg - 90) * (Math.PI / 180); 

                            
                            const x = radius * Math.cos(rad) + 110 - 14; // 110 is center, -14 is half icon width (28/2)
                            const y = radius * Math.sin(rad) + 110 - 14;

                            iconContainer.style.left = `${x}px`;
                            iconContainer.style.top = `${y}px`;

                            
                            iconContainer.innerHTML = ICONS[eventName] || DEFAULT_ICON;
                            degreeRing.appendChild(iconContainer);
                        }
                    }
                });

                if (ringGradients.length > 0) {
                    degreeRing.style.backgroundImage = ringGradients.join(',');
                } else {
                    degreeRing.style.backgroundImage = 'none';
                }

            } catch (e) {
                console.error("JSON Parse error", e);
            }
        };

        ws.onclose = () => {
            console.log("Disconnected.");
        };
    </script>
</body>
</html>
